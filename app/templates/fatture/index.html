{% extends "base.html" %}
{% block title %}Fatture SDI - Ca Bianca Gestionale{% endblock %}
{% block content %}
<div class="cb-page-header">
    <h1><i class="bi bi-file-earmark-text text-cb-green"></i> Fatture SDI</h1>
    <div class="d-flex gap-2">
        <form method="POST" action="{{ url_for('fatture.check_email') }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-cb-outline"><i class="bi bi-envelope"></i> Controlla email</button>
        </form>
        <a href="{{ url_for('fatture.upload') }}" class="btn btn-cb"><i class="bi bi-upload"></i> Carica XML</a>
    </div>
</div>

<div class="cb-filters">
    <form method="GET" class="row g-2 align-items-end">
        <div class="col-6 col-md-2">
            <label class="form-label small">Da</label>
            <input type="date" name="date_from" class="form-control form-control-sm" value="{{ request.args.get('date_from', '') }}">
        </div>
        <div class="col-6 col-md-2">
            <label class="form-label small">A</label>
            <input type="date" name="date_to" class="form-control form-control-sm" value="{{ request.args.get('date_to', '') }}">
        </div>
        <div class="col-6 col-md-2">
            <label class="form-label small">Direzione</label>
            <select name="direction" class="form-select form-select-sm">
                <option value="">Tutte</option>
                <option value="ricevuta" {% if request.args.get('direction')=='ricevuta' %}selected{% endif %}>Ricevute (acquisti)</option>
                <option value="emessa" {% if request.args.get('direction')=='emessa' %}selected{% endif %}>Emesse (vendite)</option>
                <option value="interna" {% if request.args.get('direction')=='interna' %}selected{% endif %}>Interne</option>
            </select>
        </div>
        <div class="col-6 col-md-2">
            <label class="form-label small">Tipo</label>
            <select name="tipo" class="form-select form-select-sm">
                <option value="">Tutti</option>
                {% for it in invoice_types %}
                <option value="{{ it }}" {% if request.args.get('tipo')==it %}selected{% endif %}>{{ it }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-6 col-md-2">
            <label class="form-label small">Banca</label>
            <div class="d-flex flex-column gap-1">
                <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="checkbox" name="banca" value="riconciliato" id="banca_ric" {% if 'riconciliato' in request.args.getlist('banca') %}checked{% endif %}>
                    <label class="form-check-label small" for="banca_ric"><i class="bi bi-check-circle-fill text-success"></i> Riconciliate</label>
                </div>
                <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="checkbox" name="banca" value="contanti" id="banca_cash" {% if 'contanti' in request.args.getlist('banca') %}checked{% endif %}>
                    <label class="form-check-label small" for="banca_cash"><i class="bi bi-cash-coin text-muted"></i> Contanti</label>
                </div>
                <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="checkbox" name="banca" value="in_attesa" id="banca_attesa" {% if 'in_attesa' in request.args.getlist('banca') %}checked{% endif %}>
                    <label class="form-check-label small" for="banca_attesa"><i class="bi bi-clock text-warning"></i> In attesa</label>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-2">
            <label class="form-label small">Cerca</label>
            <input type="text" name="q" class="form-control form-control-sm" placeholder="Nome, numero, P.IVA..." value="{{ request.args.get('q','') }}">
        </div>
        <div class="col-auto">
            <button class="btn btn-cb btn-sm">Filtra</button>
            <a href="{{ url_for('fatture.index') }}" class="btn btn-sm btn-outline-secondary">Reset</a>
        </div>
    </form>
</div>

<div class="d-flex justify-content-between align-items-center mb-2 px-1">
    <small class="text-muted">{{ total_count }} fattur{{ 'a' if total_count == 1 else 'e' }} trovate</small>
</div>

<div class="cb-table">
    {% if invoices %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead><tr>
                <th>Data</th><th>Numero</th><th>Mittente</th><th>P.IVA</th><th>Tipo</th><th>Dir.</th><th>Banca</th><th class="text-end">Imponibile</th><th class="text-end">IVA</th><th class="text-end">Totale</th>
            </tr></thead>
            <tbody>
                {% for inv in invoices %}
                <tr style="cursor:pointer" onclick="location.href='{{ url_for('fatture.detail', id=inv.id) }}'">
                    <td class="small text-nowrap">{{ inv.invoice_date.strftime('%d/%m/%Y') if inv.invoice_date else '-' }}</td>
                    <td>{{ inv.invoice_number }}</td>
                    <td>{{ inv.sender_name[:40] }}</td>
                    <td class="small">{{ inv.sender_partita_iva }}</td>
                    <td><span class="badge bg-secondary">{{ inv.invoice_type }}</span></td>
                    <td><span class="badge {% if inv.direction == 'ricevuta' %}badge-uscita{% elif inv.direction == 'interna' %}bg-info{% else %}badge-entrata{% endif %}">{{ inv.direction }}</span></td>
                    <td class="text-center">
                        {% if bank_status.get(inv.id) == 'riconciliato' %}
                        <i class="bi bi-check-circle-fill text-success" title="Riconciliato in banca"></i>
                        {% elif inv.id in cash_paid %}
                        <i class="bi bi-cash-coin text-muted" title="Pagato in contanti"></i>
                        {% else %}
                        <i class="bi bi-clock text-warning" title="In attesa di riconciliazione"></i>
                        {% endif %}
                    </td>
                    <td class="text-end small">&euro;{{ "{:,.2f}".format(inv.taxable_amount or 0) }}</td>
                    <td class="text-end small">&euro;{{ "{:,.2f}".format(inv.iva_amount or 0) }}</td>
                    <td class="text-end fw-bold">&euro;{{ "{:,.2f}".format(inv.total_amount or 0) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if pagination.pages > 1 %}
    {% set banca_qs = request.args.getlist('banca')|join('&banca=') %}
    {% macro page_url(p) %}?page={{ p }}&date_from={{ request.args.get('date_from','') }}&date_to={{ request.args.get('date_to','') }}&direction={{ request.args.get('direction','') }}&tipo={{ request.args.get('tipo','') }}&q={{ request.args.get('q','') }}{% if banca_qs %}&banca={{ banca_qs }}{% endif %}{% endmacro %}
    <nav class="p-3">
        <ul class="pagination pagination-sm justify-content-center mb-0">
            {% if pagination.has_prev %}
            <li class="page-item"><a class="page-link" href="{{ page_url(pagination.prev_num) }}">&laquo;</a></li>
            {% endif %}
            {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if p %}
                <li class="page-item {% if p == pagination.page %}active{% endif %}"><a class="page-link" href="{{ page_url(p) }}">{{ p }}</a></li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
                {% endif %}
            {% endfor %}
            {% if pagination.has_next %}
            <li class="page-item"><a class="page-link" href="{{ page_url(pagination.next_num) }}">&raquo;</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    {% else %}
    <div class="cb-empty">
        <i class="bi bi-file-earmark-text d-block"></i>
        <p>Nessuna fattura trovata.</p>
        <a href="{{ url_for('fatture.upload') }}" class="btn btn-cb">Carica file XML</a>
    </div>
    {% endif %}
</div>
{% endblock %}
