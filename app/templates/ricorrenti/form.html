{% extends "base.html" %}
{% block title %}{{ "Modifica" if tpl else "Nuovo" }} Template Ricorrente - Ca Bianca Gestionale{% endblock %}
{% block content %}
<div class="cb-page-header">
    <h1><i class="bi bi-arrow-repeat text-cb-green"></i> {{ "Modifica" if tpl else "Nuovo" }} Template Ricorrente</h1>
</div>

<div class="cb-card p-4" style="max-width:800px">
    <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <h6 class="text-muted mb-3"><i class="bi bi-info-circle"></i> Info template</h6>
        <div class="row g-3">
            <div class="col-md-8">
                <label class="form-label">Nome template *</label>
                <input type="text" name="name" class="form-control" value="{{ tpl.name if tpl else '' }}" required placeholder="es. Affitto mensile">
            </div>
            <div class="col-md-4">
                <label class="form-label">Tipo *</label>
                <select name="type" class="form-select" required>
                    <option value="uscita" {% if tpl and tpl.type == 'uscita' %}selected{% endif %}>Uscita</option>
                    <option value="entrata" {% if tpl and tpl.type == 'entrata' %}selected{% endif %}>Entrata</option>
                </select>
            </div>
        </div>

        <hr class="my-4">
        <h6 class="text-muted mb-3"><i class="bi bi-clock"></i> Frequenza</h6>
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Frequenza *</label>
                <select name="frequency" class="form-select" id="freqSelect" required>
                    {% for val, label in freq_labels.items() %}
                    <option value="{{ val }}" {% if tpl and tpl.frequency == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4" id="customDaysGroup" style="display:none">
                <label class="form-label">Ogni N giorni *</label>
                <input type="number" name="custom_days" class="form-control" min="1" value="{{ tpl.custom_days if tpl and tpl.custom_days else '' }}" placeholder="es. 15">
            </div>
            <div class="col-md-4">
                <label class="form-label">Finestra generazione (mesi)</label>
                <input type="number" name="generation_months" class="form-control" min="1" max="24" value="{{ tpl.generation_months if tpl else 3 }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Data inizio *</label>
                <input type="date" name="start_date" class="form-control" value="{{ tpl.start_date.isoformat() if tpl else '' }}" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Data fine (opzionale)</label>
                <input type="date" name="end_date" class="form-control" value="{{ tpl.end_date.isoformat() if tpl and tpl.end_date else '' }}">
            </div>
        </div>

        <hr class="my-4">
        <h6 class="text-muted mb-3"><i class="bi bi-receipt"></i> Dettagli movimento</h6>
        <div class="row g-3">
            <div class="col-md-8">
                <label class="form-label">Descrizione movimento</label>
                <input type="text" name="description" class="form-control" value="{{ tpl.description or '' if tpl else '' }}" placeholder="Descrizione che apparira' in prima nota">
            </div>
            <div class="col-md-4">
                <label class="form-label">Importo (EUR) *</label>
                <input type="number" step="0.01" name="amount" class="form-control" value="{{ tpl.amount if tpl else '' }}" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Aliquota IVA %</label>
                <select name="iva_rate" class="form-select">
                    <option value="0" {% if tpl and tpl.iva_rate == 0 %}selected{% endif %}>Esente</option>
                    <option value="4" {% if tpl and tpl.iva_rate == 4 %}selected{% endif %}>4%</option>
                    <option value="5" {% if tpl and tpl.iva_rate == 5 %}selected{% endif %}>5%</option>
                    <option value="10" {% if tpl and tpl.iva_rate == 10 %}selected{% endif %}>10%</option>
                    <option value="22" {% if tpl and tpl.iva_rate == 22 %}selected{% endif %}>22%</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Metodo pagamento</label>
                <select name="payment_method" class="form-select">
                    <option value="">--</option>
                    <option value="contanti" {% if tpl and tpl.payment_method == 'contanti' %}selected{% endif %}>Contanti</option>
                    <option value="bonifico" {% if tpl and tpl.payment_method == 'bonifico' %}selected{% endif %}>Bonifico</option>
                    <option value="carta" {% if tpl and tpl.payment_method == 'carta' %}selected{% endif %}>Carta</option>
                    <option value="assegno" {% if tpl and tpl.payment_method == 'assegno' %}selected{% endif %}>Assegno</option>
                    <option value="altro" {% if tpl and tpl.payment_method == 'altro' %}selected{% endif %}>Altro</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Stato pagamento</label>
                <select name="payment_status" class="form-select">
                    <option value="da_pagare" {% if tpl and tpl.payment_status == 'da_pagare' %}selected{% endif %}>Da pagare</option>
                    <option value="pagato" {% if tpl and tpl.payment_status == 'pagato' %}selected{% endif %}>Pagato</option>
                    <option value="parziale" {% if tpl and tpl.payment_status == 'parziale' %}selected{% endif %}>Parziale</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Giorni scadenza (da data)</label>
                <input type="number" name="due_days_offset" class="form-control" min="0" value="{{ tpl.due_days_offset if tpl else 0 }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Contatto</label>
                <select name="contact_id" class="form-select">
                    <option value="">--</option>
                    {% for c in contacts %}
                    <option value="{{ c.id }}" {% if tpl and tpl.contact_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Categoria</label>
                <select name="category_id" class="form-select">
                    <option value="">--</option>
                    {% for c in categories %}
                    <option value="{{ c.id }}" {% if tpl and tpl.category_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Flusso di ricavo</label>
                <select name="revenue_stream_id" class="form-select">
                    <option value="">--</option>
                    {% for s in streams %}
                    <option value="{{ s.id }}" {% if tpl and tpl.revenue_stream_id == s.id %}selected{% endif %}>{{ s.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Registrazione</label>
                <select name="official" class="form-select">
                    <option value="1" {% if not tpl or tpl.official %}selected{% endif %}>Ufficiale</option>
                    <option value="0" {% if tpl and not tpl.official %}selected{% endif %}>Extra-contabile</option>
                </select>
            </div>
            <div class="col-12">
                <label class="form-label">Note</label>
                <textarea name="notes" class="form-control" rows="2">{{ tpl.notes or '' if tpl else '' }}</textarea>
            </div>
        </div>

        {% if not tpl %}
        <hr class="my-4">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="generate_now" value="1" id="generateNow" checked>
            <label class="form-check-label" for="generateNow">
                Genera subito le transazioni nella finestra
            </label>
        </div>
        {% endif %}

        <div class="mt-4 d-flex gap-2">
            <button type="submit" class="btn btn-cb">Salva</button>
            <a href="{{ url_for('ricorrenti.index') }}" class="btn btn-outline-secondary">Annulla</a>
        </div>
    </form>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function() {
    var sel = document.getElementById('freqSelect');
    var grp = document.getElementById('customDaysGroup');
    function toggle() {
        grp.style.display = sel.value === 'custom' ? '' : 'none';
    }
    sel.addEventListener('change', toggle);
    toggle();
})();
</script>
{% endblock %}
