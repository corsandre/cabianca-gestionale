{% extends "base.html" %}
{% block title %}Movimenti Sospesi - Ca Bianca Gestionale{% endblock %}
{% block content %}
<div class="cb-page-header">
    <h1><i class="bi bi-exclamation-triangle text-cb-gold"></i> Movimenti Sospesi</h1>
    <a href="{{ url_for('banca.index') }}" class="btn btn-cb-outline btn-sm">
        <i class="bi bi-arrow-left"></i> Banca
    </a>
</div>

{% if not items %}
<div class="cb-card cb-empty">
    <i class="bi bi-check-circle d-block" style="color:#28a745"></i>
    <p>Tutti i movimenti sono riconciliati!</p>
    <a href="{{ url_for('banca.index') }}" class="btn btn-cb btn-sm">Torna alla dashboard</a>
</div>
{% else %}
<p class="text-muted mb-3">{{ total_count }} movimenti da riconciliare{% if pagination.pages > 1 %} (pagina {{ pagination.page }} di {{ pagination.pages }}){% endif %}</p>

{% for item in items %}
{% set bt = item.bt %}
{% set proposals = item.proposals %}
<div class="cb-card mb-3">
    {# Intestazione movimento bancario #}
    <div class="p-3 border-bottom" style="background:#f8f9fa; border-radius:12px 12px 0 0">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <span class="badge {{ 'badge-entrata' if bt.direction == 'C' else 'badge-uscita' }} me-1">
                    {{ 'Credito' if bt.direction == 'C' else 'Debito' }}
                </span>
                <span class="fw-bold {{ 'text-cb-dark-green' if bt.direction == 'C' else 'text-cb-gold' }}" style="font-size:1.2rem">
                    {{ '+' if bt.direction == 'C' else '-' }}&euro;{{ "{:,.2f}".format(bt.amount) }}
                </span>
                <span class="text-muted ms-2 small">{{ bt.operation_date.strftime('%d/%m/%Y') }}</span>
            </div>
            {% if bt.causale_abi %}
            <span class="badge bg-secondary">{{ bt.causale_abi }}</span>
            {% endif %}
        </div>
        <div class="mt-1">
            {% if bt.counterpart_name %}<strong>{{ bt.counterpart_name }}</strong>{% endif %}
            {% if bt.causale_description %}<span class="text-muted ms-1">| {{ bt.causale_description }}</span>{% endif %}
        </div>
        {% if bt.description %}<div class="small text-muted mt-1">{{ bt.description[:150] }}</div>{% endif %}
        {% if bt.remittance_info %}<div class="small text-muted mt-1">{{ bt.remittance_info[:150] }}</div>{% endif %}
    </div>

    {# Due colonne: proposte + abbinamento manuale #}
    <div class="row g-0">
        {# Colonna sinistra: Proposte automatiche #}
        <div class="col-lg-6 p-3 border-end">
            <h6 class="text-muted mb-2"><i class="bi bi-lightning"></i> Proposte automatiche</h6>
            {% if proposals %}
            {% for p in proposals %}
            <div class="d-flex align-items-center justify-content-between bg-light rounded p-2 mb-1">
                <div class="flex-grow-1 me-2">
                    <div class="small">
                        <span class="badge bg-{{ 'success' if p.score >= 80 else ('warning text-dark' if p.score >= 50 else 'secondary') }} me-1">{{ p.score }}%</span>
                        {{ p.transaction.description[:55] }}
                    </div>
                    <div class="small text-muted">
                        {{ p.transaction.date.strftime('%d/%m/%Y') }} |
                        &euro;{{ "{:,.2f}".format(p.transaction.amount) }} |
                        <span class="badge badge-{{ p.transaction.source }} badge-sm" style="font-size:0.65rem">{{ p.transaction.source|upper }}</span>
                        {% if p.reasons %}<br>{{ p.reasons | join(', ') }}{% endif %}
                    </div>
                </div>
                <form method="POST" action="{{ url_for('banca.riconcilia', id=bt.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="transaction_id" value="{{ p.transaction.id }}">
                    <button class="btn btn-sm btn-cb" title="Abbina"><i class="bi bi-check-lg"></i></button>
                </form>
            </div>
            {% endfor %}
            {% else %}
            <p class="small text-muted mb-0">Nessuna proposta automatica.</p>
            {% endif %}
        </div>

        {# Colonna destra: Abbinamento manuale #}
        <div class="col-lg-6 p-3">
            <h6 class="text-muted mb-2"><i class="bi bi-search"></i> Abbinamento manuale</h6>

            {# Tabs fonte #}
            <ul class="nav nav-tabs nav-tabs-sm mb-2" role="tablist" style="font-size:0.8rem">
                <li class="nav-item"><a class="nav-link active search-tab" data-bs-toggle="tab" href="#sdi-{{ bt.id }}" data-source="sdi" data-bt="{{ bt.id }}">Fatture SDI</a></li>
                <li class="nav-item"><a class="nav-link search-tab" data-bs-toggle="tab" href="#altre-{{ bt.id }}" data-source="altre" data-bt="{{ bt.id }}">Manuali/Banca</a></li>
            </ul>

            {# Barra ricerca #}
            <div class="row g-1 mb-1">
                <div class="col">
                    <input type="text" class="form-control form-control-sm search-q" data-bt="{{ bt.id }}" placeholder="Cerca descrizione, contatto...">
                </div>
                <div class="col-auto">
                    <input type="date" class="form-control form-control-sm search-from" data-bt="{{ bt.id }}">
                </div>
                <div class="col-auto">
                    <input type="date" class="form-control form-control-sm search-to" data-bt="{{ bt.id }}">
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-cb-outline search-btn" data-bt="{{ bt.id }}" title="Cerca"><i class="bi bi-search"></i></button>
                </div>
            </div>
            <div class="mb-2">
                <div class="form-check form-check-inline" style="font-size:0.8rem">
                    <input class="form-check-input search-paid" type="checkbox" data-bt="{{ bt.id }}" id="paid-{{ bt.id }}">
                    <label class="form-check-label" for="paid-{{ bt.id }}">Includi pagate</label>
                </div>
            </div>

            {# Risultati (caricati via AJAX) #}
            <div class="tab-content" style="max-height:280px; overflow-y:auto">
                <div class="tab-pane fade show active" id="sdi-{{ bt.id }}">
                    <div class="search-results" data-bt="{{ bt.id }}" data-source="sdi">
                        <p class="small text-muted mb-0">Caricamento...</p>
                    </div>
                </div>
                <div class="tab-pane fade" id="altre-{{ bt.id }}">
                    <div class="search-results" data-bt="{{ bt.id }}" data-source="altre">
                        <p class="small text-muted mb-0">Caricamento...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Azioni in fondo #}
    <div class="p-3 border-top" style="background:#fafafa; border-radius:0 0 12px 12px">
        <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-sm btn-cb-outline btn-crea-mov"
                    data-bt-id="{{ bt.id }}"
                    data-desc="{{ bt.counterpart_name or '' }} - {{ bt.causale_description or '' }}">
                <i class="bi bi-plus-circle"></i> Crea movimento
            </button>
            <button class="btn btn-sm btn-outline-secondary btn-ignora"
                    data-bt-id="{{ bt.id }}">
                <i class="bi bi-dash-circle"></i> Ignora
            </button>
            <a href="{{ url_for('banca.regola_nuova', counterpart=bt.counterpart_name or '', causale=bt.causale_abi or '', direction=bt.direction) }}"
               class="btn btn-sm btn-outline-info">
                <i class="bi bi-gear"></i> Crea regola
            </a>
        </div>
    </div>
</div>
{% endfor %}

{# Modal condiviso: Crea movimento #}
<div class="modal fade" id="modalCrea" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formCrea" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header py-2">
                    <h6 class="modal-title"><i class="bi bi-plus-circle"></i> Crea movimento</h6>
                    <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label small">Categoria</label>
                            <select name="category_id" class="form-select form-select-sm">
                                <option value="">-- Nessuna --</option>
                                {% for c in categories %}
                                <option value="{{ c.id }}">{{ c.name }} ({{ c.type }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Contatto</label>
                            <select name="contact_id" class="form-select form-select-sm">
                                <option value="">-- Nessuno --</option>
                                {% for c in contacts %}
                                <option value="{{ c.id }}">{{ c.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Flusso ricavi</label>
                            <select name="revenue_stream_id" class="form-select form-select-sm">
                                <option value="">-- Nessuno --</option>
                                {% for rs in revenue_streams %}
                                <option value="{{ rs.id }}">{{ rs.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Descrizione</label>
                            <input type="text" name="description" id="creaDescrizione" class="form-control form-control-sm">
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button class="btn btn-cb btn-sm"><i class="bi bi-plus"></i> Crea e riconcilia</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Modal condiviso: Ignora #}
<div class="modal fade" id="modalIgnora" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <form id="formIgnora" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header py-2">
                    <h6 class="modal-title"><i class="bi bi-dash-circle"></i> Ignora movimento</h6>
                    <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label small">Motivo</label>
                    <select name="ignore_reason_id" class="form-select form-select-sm">
                        <option value="">-- Senza motivo --</option>
                        {% for r in reasons %}
                        <option value="{{ r.id }}">{{ r.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button class="btn btn-sm btn-outline-danger"><i class="bi bi-dash-circle"></i> Ignora</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% if pagination.pages > 1 %}
{% macro page_url(p) %}?page={{ p }}{% endmacro %}
<nav class="my-3">
    <ul class="pagination pagination-sm justify-content-center mb-0">
        {% if pagination.has_prev %}
        <li class="page-item"><a class="page-link" href="{{ page_url(pagination.prev_num) }}">&laquo;</a></li>
        {% endif %}
        {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p %}
            <li class="page-item {% if p == pagination.page %}active{% endif %}"><a class="page-link" href="{{ page_url(p) }}">{{ p }}</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
            {% endif %}
        {% endfor %}
        {% if pagination.has_next %}
        <li class="page-item"><a class="page-link" href="{{ page_url(pagination.next_num) }}">&raquo;</a></li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
const CSRF = '{{ csrf_token() }}';

// Salva posizione scroll prima di ogni submit e ripristina al caricamento
document.querySelectorAll('form').forEach(f => {
    f.addEventListener('submit', () => {
        sessionStorage.setItem('sospesi_scroll', window.scrollY);
    });
});
(function() {
    const pos = sessionStorage.getItem('sospesi_scroll');
    if (pos) {
        sessionStorage.removeItem('sospesi_scroll');
        window.scrollTo(0, parseInt(pos));
    }
})();

function buildParams(btId, source) {
    const q = document.querySelector(`.search-q[data-bt="${btId}"]`).value;
    const dateFrom = document.querySelector(`.search-from[data-bt="${btId}"]`).value;
    const dateTo = document.querySelector(`.search-to[data-bt="${btId}"]`).value;
    const includePaid = document.querySelector(`.search-paid[data-bt="${btId}"]`).checked;
    const params = new URLSearchParams();
    if (q) params.set('q', q);
    if (dateFrom) params.set('date_from', dateFrom);
    if (dateTo) params.set('date_to', dateTo);
    if (includePaid) params.set('include_paid', '1');
    params.set('source', source);
    return params;
}

function renderResults(container, items, btId) {
    if (!items.length) {
        container.innerHTML = '<p class="small text-muted mb-0">Nessun risultato.</p>';
        return;
    }
    container.innerHTML = items.map(tx => `
        <div class="d-flex align-items-center justify-content-between border-bottom py-1">
            <div class="small flex-grow-1 me-2">
                <div>${tx.description}</div>
                <div class="text-muted">${tx.date} | &euro;${tx.amount}${tx.contact ? ' | ' + tx.contact : ''} <span class="badge badge-${tx.source.toLowerCase()}" style="font-size:0.6rem">${tx.source}</span>${tx.status ? ' <span class="badge badge-' + tx.status + '" style="font-size:0.6rem">' + tx.status.replace('_', ' ') + '</span>' : ''}</div>
            </div>
            <form method="POST" action="/banca/riconcilia/${btId}">
                <input type="hidden" name="csrf_token" value="${CSRF}">
                <input type="hidden" name="transaction_id" value="${tx.id}">
                <button class="btn btn-sm btn-outline-success" title="Abbina"><i class="bi bi-link-45deg"></i></button>
            </form>
        </div>
    `).join('');
}

function fetchSource(btId, source) {
    const params = buildParams(btId, source);
    const container = document.querySelector(`.search-results[data-bt="${btId}"][data-source="${source}"]`);
    container.innerHTML = '<p class="small text-muted">Ricerca...</p>';
    return fetch(`/banca/cerca-transazioni/${btId}?${params}`)
        .then(r => r.json())
        .then(items => {
            renderResults(container, items, btId);
            // Aggiorna conteggio nella tab
            const tab = document.querySelector(`.search-tab[data-bt="${btId}"][data-source="${source}"]`);
            if (tab) {
                const label = source === 'sdi' ? 'Fatture SDI' : 'Manuali/Banca';
                tab.textContent = `${label} (${items.length})`;
            }
            return items;
        })
        .catch(() => {
            container.innerHTML = '<p class="small text-danger mb-0">Errore di ricerca.</p>';
        });
}

function doSearch(btId) {
    fetchSource(btId, 'sdi');
    fetchSource(btId, 'altre');
}

// Click cerca
document.querySelectorAll('.search-btn').forEach(btn => {
    btn.addEventListener('click', () => doSearch(btn.dataset.bt));
});

// Enter nella casella di ricerca
document.querySelectorAll('.search-q').forEach(input => {
    input.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); doSearch(input.dataset.bt); }
    });
});

// Toggle "includi pagate": rilancia ricerca
document.querySelectorAll('.search-paid').forEach(cb => {
    cb.addEventListener('change', () => doSearch(cb.dataset.bt));
});

// Carica transazioni disponibili via AJAX al caricamento pagina
document.querySelectorAll('.search-results[data-source="sdi"]').forEach(el => {
    const btId = el.dataset.bt;
    fetchSource(btId, 'sdi');
    fetchSource(btId, 'altre');
});

// Modal "Crea movimento": imposta action URL e descrizione
document.querySelectorAll('.btn-crea-mov').forEach(btn => {
    btn.addEventListener('click', () => {
        document.getElementById('formCrea').action = `/banca/crea-movimento/${btn.dataset.btId}`;
        document.getElementById('creaDescrizione').value = btn.dataset.desc;
        new bootstrap.Modal(document.getElementById('modalCrea')).show();
    });
});

// Modal "Ignora": imposta action URL
document.querySelectorAll('.btn-ignora').forEach(btn => {
    btn.addEventListener('click', () => {
        document.getElementById('formIgnora').action = `/banca/ignora/${btn.dataset.btId}`;
        new bootstrap.Modal(document.getElementById('modalIgnora')).show();
    });
});

</script>
{% endblock %}
